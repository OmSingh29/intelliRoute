<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntelliRoute</title>

    {% load static %}
    <link href="{% static 'css/styles.css' %}" rel="stylesheet">

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .icon { width: 1.5rem; height: 1.5rem; margin-right: 0.5rem; }
    </style>
</head>

<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white rounded-2xl shadow-xl p-8 md:p-12 w-full max-w-5xl">

        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">IntelliRoute</h1>
            <p class="text-lg text-gray-700 mt-2">Paste any customer feedback to get an instant AI analysis.</p>
        </div>

        <!-- Layout Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">

            <!-- INPUT SECTION -->
            <div class="space-y-6">

                <!-- Feedback Textarea -->
                <div>
                    <label for="feedbackText" class="block text-sm font-medium text-gray-800 mb-2">Customer Feedback</label>
                    <textarea id="feedbackText" rows="12"
                        class="w-full p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition-all text-gray-900"
                        placeholder="Paste your text here..."></textarea>
                </div>

                <!-- Example Buttons -->
                <div>
                    <p class="text-sm font-medium text-gray-800 mb-3">Or try an example:</p>
                    <div class="flex flex-wrap gap-2">

                        <button class="example-btn bg-red-100 text-red-800 hover:bg-red-200 py-1 px-3 rounded-full text-sm font-medium transition-all"
                            data-text="The app is crashing every time I try to open the payments page!! I'm trying to pay my bill and it just won't load. This is ridiculous and I'm getting an error code 500. I am so frustrated!!">
                            Bug Report (Negative)
                        </button>

                        <button class="example-btn bg-green-100 text-green-800 hover:bg-green-200 py-1 px-3 rounded-full text-sm font-medium transition-all"
                            data-text="I just want to say your support team, especially Sarah, was amazing. My issue was complicated but she was so patient and fixed it for me. I really love this product, it's a lifesaver!">
                            Praise (Positive)
                        </button>

                        <button class="example-btn bg-blue-100 text-blue-800 hover:bg-blue-200 py-1 px-3 rounded-full text-sm font-medium transition-all"
                            data-text="The app is decent, but it would be really great if you could add a feature to export the reports to PDF. I have to do this manually right now and it's a bit annoying. Just an idea.">
                            Feature Request (Neutral)
                        </button>

                    </div>
                </div>

                <!-- Analyze Button -->
                <button id="analyzeButton"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg text-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">
                    <span id="button-text">Analyze Feedback</span>
                    <span id="button-spinner"
                        class="hidden animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white mx-auto">
                    </span>
                </button>
            </div>

            <!-- OUTPUT SECTION -->
            <div id="outputArea" class="space-y-6">

                <!-- Placeholder -->
                <div id="placeholder"
                    class="h-full flex flex-col items-center justify-center text-center bg-gray-50 border border-gray-300 rounded-lg p-6">
                    <svg class="w-16 h-16 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M12 21v-1m0-8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z">
                        </path>
                    </svg>
                    <h3 class="mt-4 text-lg font-medium text-gray-700">Your analysis report will appear here</h3>
                    <p class="text-sm text-gray-500 mt-1">Enter some feedback and click "Analyze".</p>
                </div>

                <!-- Analysis Report -->
                <div id="reportCard" class="hidden bg-gray-50 border border-gray-300 rounded-lg p-6 space-y-6 h-full">
                    <h2 class="text-2xl font-bold text-gray-900 border-b pb-3">Analysis Report</h2>

                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Summary</h3>
                        <p id="summaryOutput"
                            class="text-gray-800 italic bg-white p-3 rounded-md border border-gray-300"></p>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Sentiment</h3>
                        <div id="sentimentOutput"
                            class="flex items-center p-3 rounded-md font-medium text-base"></div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Suggested Routing Tags</h3>
                        <div id="tagsOutput" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <!-- Error Card -->
                <div id="errorCard" class="hidden bg-red-100 border border-red-300 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Analysis Failed</h3>
                    <p id="errorOutput" class="text-red-700"></p>
                </div>

            </div>

        </div>
    </div>

    <!-- JS (unchanged) -->
    <script>
        (function () {
        const analyzeButton = document.getElementById('analyzeButton');
        const feedbackText = document.getElementById('feedbackText');
        const buttonText = document.getElementById('button-text');
        const buttonSpinner = document.getElementById('button-spinner');
        const placeholder = document.getElementById('placeholder');
        const reportCard = document.getElementById('reportCard');
        const summaryOutput = document.getElementById('summaryOutput');
        const sentimentOutput = document.getElementById('sentimentOutput');
        const tagsOutput = document.getElementById('tagsOutput');
        const errorCard = document.getElementById('errorCard');
        const errorOutput = document.getElementById('errorOutput');

        if (!analyzeButton) {
            console.error('[analyze] analyzeButton not found in DOM — event listener not attached');
            return;
        }

        function showSpinner() {
            buttonText.style.display = 'none';
            buttonSpinner.classList.remove('hidden');
        }
        function hideSpinner() {
            buttonSpinner.classList.add('hidden');
            buttonText.style.display = '';
        }

        function showError(msg) {
            errorOutput.textContent = msg;
            errorCard.classList.remove('hidden');
            reportCard.classList.add('hidden');
            placeholder.classList.add('hidden');
        }
        function showReport(data) {
            errorCard.classList.add('hidden');
            placeholder.classList.add('hidden');
            reportCard.classList.remove('hidden');

            summaryOutput.textContent = data.summary || '';
            sentimentOutput.textContent = data.sentiment || '';
            tagsOutput.innerHTML = '';
            if (Array.isArray(data.tags)) {
            data.tags.forEach(t => {
                const el = document.createElement('span');
                el.className = 'px-3 py-1 rounded-full bg-gray-100 text-gray-800 text-sm';
                el.textContent = t;
                tagsOutput.appendChild(el);
            });
            }
        }

        async function postAnalyze(text, attempts = 3) {
            const url = 'https://intelliroute.onrender.com/api/analyze/'; // absolute prod URL
            const payload = { text };
            for (let i = 1; i <= attempts; i++) {
            try {
                console.log(`[analyze] attempt ${i} -> POST ${url}`);
                const res = await fetch(url, {
                method: 'POST',
                mode: 'cors',
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
                });

                console.log('[analyze] response status:', res.status);
                console.log('[analyze] response headers:', {
                'cf-ray': res.headers.get('cf-ray'),
                'x-render-origin-server': res.headers.get('x-render-origin-server'),
                'content-type': res.headers.get('content-type')
                });

                const txt = await res.text();
                let json = null;
                try { json = JSON.parse(txt); } catch(e) { /* not JSON */ }

                if (res.ok) {
                console.log('[analyze] OK result', json ?? txt);
                return { ok: true, body: json ?? txt, raw: txt, status: res.status };
                }

                if (res.status >= 400 && res.status < 500) {
                console.warn('[analyze] client error', res.status, txt);
                return { ok: false, error: txt || `HTTP ${res.status}`, status: res.status };
                }

                console.warn('[analyze] server error', res.status, txt);
                if (i < attempts) {
                await new Promise(r => setTimeout(r, 300 * i));
                continue;
                }
                return { ok: false, error: txt || `HTTP ${res.status}`, status: res.status };

            } catch (err) {
                console.error('[analyze] fetch threw', err);
                if (i < attempts) {
                await new Promise(r => setTimeout(r, 300 * i));
                continue;
                }
                return { ok: false, error: String(err) };
            }
            }
        }

        analyzeButton.addEventListener('click', async (e) => {
            e.preventDefault();
            console.log('[analyze] button clicked');

            const text = feedbackText.value || '';
            if (!text.trim()) {
            showError('Please enter some feedback text before analyzing.');
            return;
            }

            errorCard.classList.add('hidden');
            reportCard.classList.add('hidden');
            placeholder.classList.remove('hidden');

            showSpinner();

            const result = await postAnalyze(text, 3);

            hideSpinner();

            if (!result.ok) {
            console.error('[analyze] failed result', result);
            showError(result.error || `Request failed (status: ${result.status || 'unknown'}) — check console for details.`);
            return;
            }

            const body = result.body;
            if (typeof body === 'string') {
            try {
                const parsed = JSON.parse(body);
                showReport(parsed);
            } catch (e) {
                showError('Server returned non-JSON response. Check console for details.');
                console.log('[analyze] raw body:', body);
            }
            } else {
            showReport(body);
            }
        });

        console.log('[analyze] debug script loaded — event listener attached');
        })();
    </script>


</body>
</html>