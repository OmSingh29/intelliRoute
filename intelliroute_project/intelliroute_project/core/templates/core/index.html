<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntelliRoute</title>
    <!-- Load Tailwind CSS -->
    {% load static %}
    <link href="{% static 'css/styles.css' %}" rel="stylesheet">
    <!-- Load Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .icon { width: 1.5rem; height: 1.5rem; margin-right: 0.5rem; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white rounded-2xl shadow-2xl p-8 md:p-12 w-full max-w-5xl">
        
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">IntelliRoute</h1>
            <p class="text-lg text-gray-600 mt-2">Paste any customer feedback to get an instant AI analysis.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">
            
            <!-- ====== INPUT COLUMN ====== -->
            <div class="space-y-6">
                <div>
                    <label for="feedbackText" class="block text-sm font-medium text-gray-700 mb-2">Customer Feedback</label>
                    <textarea id="feedbackText" rows="12" class="w-full p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-gray-800" placeholder="Paste your text here..."></textarea>
                </div>
                
                <!-- Example Buttons -->
                <div>
                    <p class="text-sm font-medium text-gray-700 mb-3">Or try an example:</p>
                    <div class="flex flex-wrap gap-2">
                        <button class="example-btn bg-red-100 text-red-800 hover:bg-red-200 py-1 px-3 rounded-full text-sm font-medium transition-all" 
                                data-text="The app is crashing every time I try to open the payments page!! I'm trying to pay my bill and it just won't load. This is ridiculous and I'm getting an error code 500. I am so frustrated!!">
                            Bug Report (Negative)
                        </button>
                        <button class="example-btn bg-green-100 text-green-800 hover:bg-green-200 py-1 px-3 rounded-full text-sm font-medium transition-all" 
                                data-text="I just want to say your support team, especially Sarah, was amazing. My issue was complicated but she was so patient and fixed it for me. I really love this product, it's a lifesaver!">
                            Praise (Positive)
                        </button>
                        <button class="example-btn bg-blue-100 text-blue-800 hover:bg-blue-200 py-1 px-3 rounded-full text-sm font-medium transition-all" 
                                data-text="The app is decent, but it would be really great if you could add a feature to export the reports to PDF. I have to do this manually right now and it's a bit annoying. Just an idea.">
                            Feature Request (Neutral)
                        </button>
                    </div>
                </div>
                
                <button id="analyzeButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg text-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">
                    <span id="button-text">Analyze Feedback</span>
                    <span id="button-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white mx-auto"></span>
                </button>
            </div>

            <!-- ====== OUTPUT COLUMN ====== -->
            <div id="outputArea" class="space-y-6">
                <!-- Initial Placeholder -->
                <div id="placeholder" class="h-full flex flex-col items-center justify-center text-center bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-6">
                    <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M12 21v-1m0-8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"></path></svg>
                    <h3 class="mt-4 text-lg font-medium text-gray-700">Your analysis report will appear here</h3>
                    <p class="text-sm text-gray-500 mt-1">Enter some feedback and click "Analyze".</p>
                </div>

                <!-- Analysis Report (Hidden by default) -->
                <div id="reportCard" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-6 space-y-6 h-full">
                    <h2 class="text-2xl font-bold text-gray-900 border-b pb-3">Analysis Report</h2>
                    
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Summary</h3>
                        <p id="summaryOutput" class="text-gray-700 italic bg-white p-3 rounded-md border border-gray-200"></p>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Sentiment</h3>
                        <div id="sentimentOutput" class="flex items-center p-3 rounded-md font-medium text-base"></div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Suggested Routing Tags</h3>
                        <div id="tagsOutput" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <!-- Error Message (Hidden by default) -->
                <div id="errorCard" class="hidden bg-red-50 border border-red-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Analysis Failed</h3>
                    <p id="errorOutput" class="text-red-700"></p>
                </div>
            </div>

        </div> <!-- /grid -->
    </div> <!-- /main card -->

    <script>
        // Get all the DOM elements
        const analyzeButton = document.getElementById('analyzeButton');
        const buttonText = document.getElementById('button-text');
        const buttonSpinner = document.getElementById('button-spinner');
        const feedbackText = document.getElementById('feedbackText');
        const exampleButtons = document.querySelectorAll('.example-btn');
        
        const placeholder = document.getElementById('placeholder');
        const reportCard = document.getElementById('reportCard');
        const errorCard = document.getElementById('errorCard');
        
        const summaryOutput = document.getElementById('summaryOutput');
        const sentimentOutput = document.getElementById('sentimentOutput');
        const tagsOutput = document.getElementById('tagsOutput');
        const errorOutput = document.getElementById('errorOutput');

        // --- Main Event Listener for the Analyze Button ---
        analyzeButton.addEventListener('click', async () => {
            const text = feedbackText.value;
            if (text.trim() === '') {
                showError("Text input cannot be empty.");
                return;
            }

            // 1. Show the loading state
            setLoading(true);

            try {
                // 2. Call our Django API endpoint
                const response = await fetch('/api/analyze/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // @csrf_exempt in Django means we don't need a token here
                    },
                    body: JSON.stringify({ text: text })
                });

                const report = await response.json();

                if (!response.ok) {
                    // If the server returned an error (like 400 or 500)
                    throw new Error(report.error || "An unknown server error occurred.");
                }
                
                // 3. Display the report
                displayReport(report);

            } catch (error) {
                console.error("Analysis failed:", error);
                showError(error.message);
            } finally {
                // 4. Hide loading state
                setLoading(false);
            }
        });

        // --- Event Listeners for Example Buttons ---
        exampleButtons.forEach(button => {
            button.addEventListener('click', () => {
                feedbackText.value = button.getAttribute('data-text');
            });
        });

        function setLoading(isLoading) {
            if (isLoading) {
                buttonText.classList.add('hidden');
                buttonSpinner.classList.remove('hidden');
                analyzeButton.disabled = true;
                placeholder.classList.add('hidden');
                reportCard.classList.add('hidden');
                errorCard.classList.add('hidden');
            } else {
                buttonText.classList.remove('hidden');
                buttonSpinner.classList.add('hidden');
                analyzeButton.disabled = false;
            }
        }

        function showError(message) {
            placeholder.classList.add('hidden');
            reportCard.classList.add('hidden');
            errorCard.classList.remove('hidden');
            errorOutput.textContent = message;
        }

        function displayReport(report) {
            placeholder.classList.add('hidden');
            errorCard.classList.add('hidden');
            reportCard.classList.remove('hidden');
            reportCard.classList.add('animate-fade-in');

            // 1. Update Summary
            summaryOutput.textContent = report.summary;

            // 2. Update Sentiment
            let sentimentIcon = '';
            let sentimentColorClasses = '';
            
            // Use .toLowerCase() for a robust check
            switch (report.sentiment.toLowerCase()) {
                case 'positive':
                    sentimentIcon = `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                    sentimentColorClasses = 'bg-green-100 text-green-800';
                    break;
                case 'negative':
                    sentimentIcon = `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                    sentimentColorClasses = 'bg-red-100 text-red-800';
                    break;
                default: // Neutral
                    sentimentIcon = `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                    sentimentColorClasses = 'bg-yellow-100 text-yellow-800';
            }
            sentimentOutput.innerHTML = `${sentimentIcon} <span>${report.sentiment}</span>`;
            sentimentOutput.className = `flex items-center p-3 rounded-md font-medium text-base ${sentimentColorClasses}`;

            // 3. Update Tags
            tagsOutput.innerHTML = ''; // Clear old tags
            report.tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.textContent = tag;
                tagElement.className = `py-1 px-3 rounded-full text-sm font-medium ${getTagClasses(tag)}`;
                tagsOutput.appendChild(tagElement);
            });
        }

        function getTagClasses(tag) {
            // Add a check for null/undefined tags
            if (!tag) return 'bg-gray-200 text-gray-800';
            
            const lowerTag = tag.toLowerCase();
            if (lowerTag.includes('urgent')) return 'bg-red-200 text-red-900';
            if (lowerTag.includes('support')) return 'bg-blue-200 text-blue-900';
            if (lowerTag.includes('bug')) return 'bg-purple-200 text-purple-900';
            if (lowerTag.includes('billing')) return 'bg-yellow-200 text-yellow-900';
            if (lowerTag.includes('feature')) return 'bg-green-200 text-green-900';
            if (lowerTag.includes('praise')) return 'bg-indigo-200 text-indigo-900';
            
            // Default for "General Feedback"
            return 'bg-gray-200 text-gray-800';
        }
    </script>
</body>
</html>